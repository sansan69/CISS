rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Rules for the 'employees' collection
    match /employees/{employeeId} {
      
      // Allow read access to an employee document if:
      // 1. The user is an authenticated admin (has an email).
      // OR
      // 2. The user is authenticated with a phone number that matches the document's phone number.
      allow read: if request.auth != null && 
                    (
                      request.auth.token.email != null ||
                      request.auth.token.phone_number == resource.data.phoneNumber
                    );

      // Allow a user to create a new employee document if:
      // 1. They are authenticated (e.g., via phone OTP).
      // 2. The phone number in their auth token matches the phone number in the document being created.
      allow create: if request.auth != null && 
                      request.auth.token.phone_number == request.resource.data.phoneNumber;

      // Allow updates if:
      // 1. The user is an authenticated admin (identified by having an email in their token).
      // OR
      // 2. The user is an employee verified via OTP, their phone number matches the document's phone number,
      //    and they are not trying to change their own phone number.
      allow update: if request.auth != null && 
                      (
                        request.auth.token.email != null ||
                        (
                          request.auth.token.phone_number == resource.data.phoneNumber &&
                          request.resource.data.phoneNumber == resource.data.phoneNumber
                        )
                      );

      // Only allow authenticated admins to delete employee records.
      allow delete: if request.auth != null && request.auth.token.email != null;
    }

    // Rules for the 'clients' collection
    match /clients/{clientId} {

      // Allow anyone to read the list of clients. 
      // This is required for the client dropdown on the enrollment forms to work.
      allow read: if true;

      // Only allow authenticated admins to add, update, or delete clients.
      allow create, update, delete: if request.auth != null && request.auth.token.email != null;
    }
  }
}
