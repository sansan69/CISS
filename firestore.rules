rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Rules for the 'employees' collection
    match /employees/{employeeId} {
      
      // Allow reading a single document if the user is authenticated as an admin OR 
      // is the employee themselves (verified by phone number).
      // Also allows anyone to read the non-sensitive 'publicProfile' map.
      allow get: if (request.auth != null && request.auth.token.email != null) || 
                   (request.auth != null && request.auth.token.phone_number == resource.data.phoneNumber) ||
                   (resource.data.keys().hasAny(['publicProfile']));

      // Only allow authenticated admins to list documents.
      allow list: if request.auth != null && request.auth.token.email != null;

      // Allow a new employee document to be created if the user is anonymous (public enrollment)
      // and the request contains the minimum required fields. This relies on client-side validation.
      allow create: if request.auth == null &&
                       "phoneNumber" in request.resource.data &&
                       "fullName" in request.resource.data;

      // Allow updates if:
      // 1. The user is an authenticated admin.
      // 2. The user is an employee verified via OTP, and their phone number matches the document's phone number.
      // This prevents users from updating other people's documents or changing their own phone number.
      allow update: if (request.auth != null && request.auth.token.email != null) || 
                      (request.auth != null && request.auth.token.phone_number == resource.data.phoneNumber && request.resource.data.phoneNumber == resource.data.phoneNumber);

      // Only allow authenticated admins to delete employee records.
      allow delete: if request.auth != null && request.auth.token.email != null;
    }

    // Rules for the 'clients' collection
    match /clients/{clientId} {

      // Allow anyone to read the list of clients for dropdowns.
      allow read: if true;

      // Only allow authenticated admins to add, update, or delete clients.
      allow create, update, delete: if request.auth != null && request.auth.token.email != null;
    }
  }
}
