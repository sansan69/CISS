rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    
    // Employee document paths: /employees/{phoneNumber}/{documentType}/{fileName}
    match /employees/{phoneNumber}/{documentType}/{fileName} {
      
      // --- CREATE Rule (For New Enrollments) ---
      // Allow unauthenticated users to upload files ONLY during initial creation.
      // This is essential for the public enrollment form to work.
      // This is secure because the path is unpredictable without the phone number,
      // and we apply strict validation on what can be uploaded.
      allow create: if documentType in ['profilePictures', 'idProofs', 'addressProofs', 'signatures', 'bankDocuments', 'policeCertificates'] &&
                     request.resource.size < 5 * 1024 * 1024 &&
                     (request.resource.contentType.matches('image/.*') || request.resource.contentType == 'application/pdf');

      // --- UPDATE Rule (For Existing Employees) ---
      // Allow authenticated admins or the employee themselves (matching phone number) to update files.
      allow update: if request.auth != null && (
                      (request.auth.token.email != null) ||
                      (request.auth.token.phone_number == '+91' + phoneNumber)
                    ) &&
                    documentType in ['profilePictures', 'idProofs', 'addressProofs', 'signatures', 'bankDocuments', 'policeCertificates'] &&
                    request.resource.size < 5 * 1024 * 1024 &&
                    (request.resource.contentType.matches('image/.*') || request.resource.contentType == 'application/pdf');


      // --- READ and DELETE Rules ---
      // Only allow admins to read or delete files directly.
      allow read, delete: if request.auth != null && request.auth.token.email != null;
    }

    // Default deny all other reads/writes to bucket paths.
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
