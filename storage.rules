rules_version = '2';

service firebase.storage {
  // Match the entire bucket.
  match /b/{bucket}/o {

    // Rule for employee-specific document paths.
    // Path: /employees/{10-digit-phoneNumber}/{documentType}/{fileName}
    match /employees/{phoneNumber}/{documentType}/{fileName} {
      
      // --- WRITE (Create/Update) Rule ---
      // This is the primary rule for all uploads into employee folders.
      allow write: if 
        // File validation must always pass
        (
          request.resource.size < 5 * 1024 * 1024 &&
          (request.resource.contentType.matches('image/.*') || request.resource.contentType == 'application/pdf') &&
          documentType in ['profilePictures', 'idProofs', 'addressProofs', 'signatures', 'bankDocuments', 'policeCertificates']
        ) && (
          // CONDITION 1: Allow for Public Enrollment (user is not logged in)
          // This allows anyone to upload files during the enrollment process.
          // It is safe because the path is specific and files are validated.
          request.auth == null ||

          // CONDITION 2: Allow for Admins and Authenticated Employees
          // This allows logged-in admins or the employee themselves to update files.
          (
            request.auth != null && (
              (request.auth.token.email != null) || // Is an admin
              (request.auth.token.phone_number == '+91' + phoneNumber) // Is the matching employee
            )
          )
        );

      // --- READ and DELETE Rules ---
      // Only allow admins to read or delete directly.
      // Regular users get access via download URLs generated by the application.
      allow read, delete: if request.auth != null && request.auth.token.email != null;
    }
  }
}
